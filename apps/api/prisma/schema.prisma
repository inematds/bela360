// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum BusinessType {
  SALON
  BARBERSHOP
  AESTHETICS
  SPA
  OTHER
}

enum BusinessStatus {
  PENDING
  ACTIVE
  SUSPENDED
  CANCELLED
}

enum UserRole {
  OWNER
  ADMIN
  PROFESSIONAL
  RECEPTIONIST
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  NO_SHOW
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

enum MessageStatus {
  PENDING
  SENT
  DELIVERED
  READ
  FAILED
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

// ============================================
// CORE MODELS
// ============================================

model Business {
  id          String         @id @default(cuid())
  name        String
  slug        String         @unique
  phone       String         @unique
  email       String?
  type        BusinessType   @default(SALON)
  status      BusinessStatus @default(PENDING)

  // Address
  address     String?
  city        String?
  state       String?
  zipCode     String?

  // WhatsApp Integration
  whatsappInstanceId   String?   @unique
  whatsappConnected    Boolean   @default(false)
  whatsappConnectedAt  DateTime?

  // Settings (JSON)
  settings    Json           @default("{}")

  // Timestamps
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  // Relations
  users           User[]
  services        Service[]
  clients         Client[]
  appointments    Appointment[]
  workingHours    WorkingHours[]
  messages        Message[]
  messageTemplates MessageTemplate[]

  // Epic 6-10 relations
  automations     Automation[]
  waitlist        Waitlist[]
  payments        Payment[]
  commissionConfigs CommissionConfig[]
  cashRegisters   CashRegister[]
  campaigns       Campaign[]
  clientRatings   ClientRating[]

  // Epic 11-13 relations
  loyaltyProgram  LoyaltyProgram?
  loyaltyPoints   LoyaltyPoints[]
  products        Product[]
  stockMovements  StockMovement[]
  professionalGoals ProfessionalGoal[]
  professionalRankings ProfessionalRanking[]
  marketingSuggestions MarketingSuggestion[]
  contentTemplates ContentTemplate[]

  @@index([phone])
  @@index([status])
  @@map("businesses")
}

model User {
  id           String    @id @default(cuid())
  businessId   String
  name         String
  phone        String
  email        String?
  role         UserRole  @default(PROFESSIONAL)
  isActive     Boolean   @default(true)

  // Authentication
  otpCode      String?
  otpExpiresAt DateTime?
  lastLoginAt  DateTime?

  // Professional specific
  color        String?   // Calendar color
  commission   Decimal?  @db.Decimal(5, 2) // Commission percentage

  // Timestamps
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  business     Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  appointments Appointment[] @relation("ProfessionalAppointments")
  services     ServiceProfessional[]
  workingHours WorkingHours[]

  // Epic 6-10 relations
  waitlistEntries    Waitlist[]
  paymentsReceived   Payment[] @relation("ProfessionalPayments")
  paymentsRegistered Payment[] @relation("RegisteredPayments")
  commissionConfigs  CommissionConfig[] @relation("ProfessionalCommissionConfigs")
  cashRegistersClosed CashRegister[]
  ratings            ClientRating[] @relation("ProfessionalRatings")

  // Epic 11-13 relations
  stockMovements     StockMovement[]
  professionalProfile ProfessionalProfile?
  professionalRankings ProfessionalRanking[]

  @@unique([businessId, phone])
  @@index([businessId])
  @@index([phone])
  @@map("users")
}

model Service {
  id           String    @id @default(cuid())
  businessId   String
  name         String
  description  String?
  duration     Int       // Duration in minutes
  price        Decimal   @db.Decimal(10, 2)
  isActive     Boolean   @default(true)

  // Timestamps
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  business     Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  professionals ServiceProfessional[]
  appointments Appointment[]

  // Epic 6-10 relations
  automations  Automation[]
  waitlistEntries Waitlist[]
  commissionConfigs CommissionConfig[]

  // Epic 11-12 relations
  loyaltyRewards   LoyaltyReward[]
  serviceProducts  ServiceProduct[]

  @@index([businessId])
  @@index([businessId, isActive])
  @@map("services")
}

model ServiceProfessional {
  id            String   @id @default(cuid())
  serviceId     String
  professionalId String
  customDuration Int?    // Override service duration
  customPrice    Decimal? @db.Decimal(10, 2) // Override service price

  // Relations
  service      Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  professional User     @relation(fields: [professionalId], references: [id], onDelete: Cascade)

  @@unique([serviceId, professionalId])
  @@map("service_professionals")
}

model Client {
  id           String    @id @default(cuid())
  businessId   String
  name         String
  phone        String
  email        String?
  birthDate    DateTime?
  notes        String?

  // Preferences
  preferredProfessionalId String?

  // Stats (denormalized for performance)
  totalAppointments Int      @default(0)
  totalSpent        Decimal  @default(0) @db.Decimal(10, 2)
  lastVisitAt       DateTime?

  // Timestamps
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  business     Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  appointments Appointment[]
  messages     Message[]

  // Epic 6-10 relations
  automationLogs     AutomationLog[]
  waitlistEntries    Waitlist[]
  payments           Payment[]
  campaignRecipients CampaignRecipient[]
  ratings            ClientRating[]

  // Epic 11 relations
  loyaltyPoints      LoyaltyPoints?
  loyaltyRedemptions LoyaltyRedemption[]

  @@unique([businessId, phone])
  @@index([businessId])
  @@index([phone])
  @@index([businessId, lastVisitAt])
  @@map("clients")
}

model Appointment {
  id             String            @id @default(cuid())
  businessId     String
  clientId       String
  professionalId String
  serviceId      String

  // Scheduling
  startTime      DateTime
  endTime        DateTime
  status         AppointmentStatus @default(PENDING)

  // Notes
  notes          String?
  cancellationReason String?

  // Reminders
  reminderSentAt DateTime?
  confirmedAt    DateTime?

  // Timestamps
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  // Relations
  business       Business          @relation(fields: [businessId], references: [id], onDelete: Cascade)
  client         Client            @relation(fields: [clientId], references: [id], onDelete: Cascade)
  professional   User              @relation("ProfessionalAppointments", fields: [professionalId], references: [id], onDelete: Cascade)
  service        Service           @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  // Epic 6-10 relations
  payments       Payment[]
  rating         ClientRating?

  @@index([businessId])
  @@index([businessId, startTime])
  @@index([professionalId, startTime])
  @@index([clientId])
  @@index([status])
  @@map("appointments")
}

model WorkingHours {
  id             String    @id @default(cuid())
  businessId     String
  professionalId String?   // null = business-wide hours
  dayOfWeek      DayOfWeek

  // Time slots (stored as HH:MM)
  startTime      String    // e.g., "09:00"
  endTime        String    // e.g., "18:00"

  // Break time
  breakStart     String?   // e.g., "12:00"
  breakEnd       String?   // e.g., "13:00"

  isActive       Boolean   @default(true)

  // Relations
  business       Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  professional   User?     @relation(fields: [professionalId], references: [id], onDelete: Cascade)

  @@unique([businessId, professionalId, dayOfWeek])
  @@index([businessId])
  @@index([professionalId])
  @@map("working_hours")
}

// ============================================
// MESSAGING MODELS
// ============================================

model Message {
  id           String           @id @default(cuid())
  businessId   String
  clientId     String?

  // WhatsApp specific
  whatsappMessageId String?     @unique
  remoteJid    String           // WhatsApp JID

  // Content
  direction    MessageDirection
  content      String
  mediaUrl     String?
  mediaType    String?

  // Status
  status       MessageStatus    @default(PENDING)
  sentAt       DateTime?
  deliveredAt  DateTime?
  readAt       DateTime?
  failedReason String?

  // Context
  isFromBot    Boolean          @default(false)
  intent       String?          // Detected intent (scheduling, info, etc.)

  // Timestamps
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  // Relations
  business     Business         @relation(fields: [businessId], references: [id], onDelete: Cascade)
  client       Client?          @relation(fields: [clientId], references: [id], onDelete: SetNull)

  @@index([businessId])
  @@index([businessId, createdAt])
  @@index([clientId])
  @@index([remoteJid])
  @@map("messages")
}

model MessageTemplate {
  id           String    @id @default(cuid())
  businessId   String
  name         String
  type         String    // confirmation, reminder, welcome, etc.
  content      String    // Template with variables like {{client_name}}
  isActive     Boolean   @default(true)

  // Timestamps
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  business     Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, type])
  @@index([businessId])
  @@map("message_templates")
}

// ============================================
// ANALYTICS MODELS
// ============================================

model DailyStats {
  id                 String   @id @default(cuid())
  businessId         String
  date               DateTime @db.Date

  // Appointment stats
  totalAppointments  Int      @default(0)
  confirmedCount     Int      @default(0)
  cancelledCount     Int      @default(0)
  noShowCount        Int      @default(0)
  completedCount     Int      @default(0)

  // Revenue
  totalRevenue       Decimal  @default(0) @db.Decimal(10, 2)

  // Client stats
  newClients         Int      @default(0)
  returningClients   Int      @default(0)

  // Message stats
  messagesSent       Int      @default(0)
  messagesReceived   Int      @default(0)

  // Timestamps
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@unique([businessId, date])
  @@index([businessId])
  @@index([businessId, date])
  @@map("daily_stats")
}

// ============================================
// EPIC 6: AUTOMAÇÃO DE RELACIONAMENTO
// ============================================

enum AutomationType {
  POST_APPOINTMENT   // Mensagem pós-atendimento
  RETURN_REMINDER    // Lembrete de retorno
  BIRTHDAY           // Aniversário
  REACTIVATION       // Reativação de inativos
}

enum AutomationLogStatus {
  PENDING
  SENT
  FAILED
  SKIPPED
}

model Automation {
  id           String         @id @default(cuid())
  businessId   String
  type         AutomationType
  isActive     Boolean        @default(true)

  // Configuration
  delayHours   Int?           // Delay após evento (ex: 2h após atendimento)
  delayDays    Int?           // Delay em dias (ex: 30 dias para retorno)
  sendTime     String?        // Horário de envio (ex: "09:00")

  // Template
  template     String         // Mensagem com variáveis {{nome}}, {{servico}}, etc.

  // For return reminders - per service configuration
  serviceId    String?        // Se específico para um serviço

  // Stats
  totalSent    Int            @default(0)
  totalConverted Int          @default(0)  // Quantos geraram agendamento

  // Timestamps
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  // Relations
  business     Business       @relation(fields: [businessId], references: [id], onDelete: Cascade)
  service      Service?       @relation(fields: [serviceId], references: [id], onDelete: SetNull)
  logs         AutomationLog[]

  @@unique([businessId, type, serviceId])
  @@index([businessId])
  @@index([businessId, type])
  @@map("automations")
}

model AutomationLog {
  id           String              @id @default(cuid())
  automationId String
  clientId     String
  appointmentId String?            // Relacionado a qual agendamento (se aplicável)

  // Status
  status       AutomationLogStatus @default(PENDING)
  scheduledFor DateTime            // Quando deve ser enviado
  sentAt       DateTime?
  failedReason String?

  // Tracking
  convertedToAppointment Boolean   @default(false)
  convertedAppointmentId String?   // Se gerou novo agendamento

  // Timestamps
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  // Relations
  automation   Automation          @relation(fields: [automationId], references: [id], onDelete: Cascade)
  client       Client              @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([automationId])
  @@index([clientId])
  @@index([status, scheduledFor])
  @@map("automation_logs")
}

// ============================================
// EPIC 7: LISTA DE ESPERA
// ============================================

enum WaitlistStatus {
  WAITING
  NOTIFIED
  CONVERTED
  EXPIRED
  CANCELLED
}

enum DayPeriod {
  MORNING    // 06:00 - 12:00
  AFTERNOON  // 12:00 - 18:00
  EVENING    // 18:00 - 22:00
  ANY
}

model Waitlist {
  id             String         @id @default(cuid())
  businessId     String
  clientId       String
  serviceId      String
  professionalId String?        // null = qualquer profissional

  // Preferences
  desiredDate    DateTime       @db.Date
  desiredPeriod  DayPeriod      @default(ANY)

  // Status
  status         WaitlistStatus @default(WAITING)
  notifiedAt     DateTime?
  expiresAt      DateTime?      // 30min após notificação

  // Conversion tracking
  convertedAppointmentId String?

  // Priority (timestamp for FIFO)
  priority       DateTime       @default(now())

  // Timestamps
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  // Relations
  business       Business       @relation(fields: [businessId], references: [id], onDelete: Cascade)
  client         Client         @relation(fields: [clientId], references: [id], onDelete: Cascade)
  service        Service        @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  professional   User?          @relation(fields: [professionalId], references: [id], onDelete: SetNull)

  @@index([businessId])
  @@index([businessId, desiredDate, status])
  @@index([clientId])
  @@index([status, desiredDate])
  @@map("waitlist")
}

// ============================================
// EPIC 9: CONTROLE FINANCEIRO
// ============================================

enum PaymentMethod {
  CASH
  PIX
  CREDIT_CARD
  DEBIT_CARD
  OTHER
}

enum PaymentStatus {
  PENDING
  COMPLETED
  PARTIAL
  REFUNDED
  CANCELLED
}

model Payment {
  id             String        @id @default(cuid())
  businessId     String
  appointmentId  String
  clientId       String
  professionalId String

  // Values
  amount         Decimal       @db.Decimal(10, 2)
  discount       Decimal       @default(0) @db.Decimal(10, 2)
  finalAmount    Decimal       @db.Decimal(10, 2)

  // Payment info
  method         PaymentMethod
  status         PaymentStatus @default(COMPLETED)

  // Commission
  commissionRate Decimal       @db.Decimal(5, 2)  // Percentage
  commissionAmount Decimal     @db.Decimal(10, 2) // Calculated amount
  businessAmount Decimal       @db.Decimal(10, 2) // What stays with business

  // Receipt
  receiptUrl     String?       // Photo of receipt if any
  notes          String?

  // Who registered
  registeredById String

  // Timestamps
  paidAt         DateTime      @default(now())
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Relations
  business       Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)
  appointment    Appointment   @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  client         Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  professional   User          @relation("ProfessionalPayments", fields: [professionalId], references: [id], onDelete: Cascade)
  registeredBy   User          @relation("RegisteredPayments", fields: [registeredById], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([businessId, paidAt])
  @@index([professionalId])
  @@index([appointmentId])
  @@map("payments")
}

model CommissionConfig {
  id             String   @id @default(cuid())
  businessId     String
  professionalId String
  serviceId      String?  // null = default for all services

  // Rate
  rate           Decimal  @db.Decimal(5, 2)  // Percentage (0-100)
  fixedAmount    Decimal? @db.Decimal(10, 2) // Or fixed amount per service

  // Timestamps
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  business       Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  professional   User     @relation("ProfessionalCommissionConfigs", fields: [professionalId], references: [id], onDelete: Cascade)
  service        Service? @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([businessId, professionalId, serviceId])
  @@index([businessId])
  @@index([professionalId])
  @@map("commission_configs")
}

model CashRegister {
  id             String   @id @default(cuid())
  businessId     String
  date           DateTime @db.Date

  // Totals by payment method
  cashTotal      Decimal  @default(0) @db.Decimal(10, 2)
  pixTotal       Decimal  @default(0) @db.Decimal(10, 2)
  creditTotal    Decimal  @default(0) @db.Decimal(10, 2)
  debitTotal     Decimal  @default(0) @db.Decimal(10, 2)
  otherTotal     Decimal  @default(0) @db.Decimal(10, 2)

  // Summary
  totalRevenue   Decimal  @default(0) @db.Decimal(10, 2)
  totalCommissions Decimal @default(0) @db.Decimal(10, 2)
  businessProfit Decimal  @default(0) @db.Decimal(10, 2)

  // Counts
  appointmentCount Int    @default(0)

  // Status
  isClosed       Boolean  @default(false)
  closedAt       DateTime?
  closedById     String?

  // Notes
  notes          String?

  // Timestamps
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  business       Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  closedBy       User?    @relation(fields: [closedById], references: [id], onDelete: SetNull)

  @@unique([businessId, date])
  @@index([businessId])
  @@index([businessId, date])
  @@map("cash_registers")
}

// ============================================
// EPIC 10: MARKETING BÁSICO
// ============================================

enum ClientSegmentType {
  ALL            // All active clients
  VIP            // Top 10% by spending
  NEW            // First visit in last 30 days
  LOYAL          // 5+ visits
  INACTIVE       // No visit in 60+ days
  RECURRING      // 2-4 visits in 3 months
  BIRTHDAY_MONTH // Clients with birthday this month
  CUSTOM         // Custom segment
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  COMPLETED
  CANCELLED
}

model Campaign {
  id             String         @id @default(cuid())
  businessId     String
  name           String

  // Target
  segmentType    ClientSegmentType?
  customFilter   Json?          // Custom filter criteria

  // Content
  message        String

  // Scheduling
  status         CampaignStatus @default(DRAFT)
  scheduledFor   DateTime?
  startedAt      DateTime?
  completedAt    DateTime?

  // Stats
  totalRecipients Int           @default(0)
  sentCount      Int            @default(0)
  failedCount    Int            @default(0)
  respondedCount Int            @default(0)
  convertedCount Int            @default(0)  // Generated appointments

  // Timestamps
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  // Relations
  business       Business       @relation(fields: [businessId], references: [id], onDelete: Cascade)
  recipients     CampaignRecipient[]

  @@index([businessId])
  @@index([businessId, status])
  @@map("campaigns")
}

model CampaignRecipient {
  id             String   @id @default(cuid())
  campaignId     String
  clientId       String

  // Status
  sentAt         DateTime?
  deliveredAt    DateTime?
  readAt         DateTime?
  respondedAt    DateTime?
  failed         Boolean  @default(false)
  failedReason   String?

  // Conversion
  convertedToAppointment Boolean @default(false)
  appointmentId  String?

  // Timestamps
  createdAt      DateTime @default(now())

  // Relations
  campaign       Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  client         Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([campaignId, clientId])
  @@index([campaignId])
  @@index([clientId])
  @@map("campaign_recipients")
}

// ============================================
// CLIENT RATING (for post-appointment feedback)
// ============================================

model ClientRating {
  id             String   @id @default(cuid())
  businessId     String
  clientId       String
  appointmentId  String   @unique
  professionalId String

  // Rating
  rating         Int      // 1-5 stars
  comment        String?

  // Professional response
  response       String?
  respondedAt    DateTime?

  // Timestamps
  createdAt      DateTime @default(now())

  // Relations
  business       Business    @relation(fields: [businessId], references: [id], onDelete: Cascade)
  client         Client      @relation(fields: [clientId], references: [id], onDelete: Cascade)
  appointment    Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  professional   User        @relation("ProfessionalRatings", fields: [professionalId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([professionalId])
  @@index([clientId])
  @@map("client_ratings")
}

// ============================================
// EPIC 11: PROGRAMA DE FIDELIDADE
// ============================================

enum LoyaltyTier {
  BRONZE
  SILVER
  GOLD
  DIAMOND
}

enum RewardType {
  DISCOUNT_PERCENT
  DISCOUNT_FIXED
  FREE_SERVICE
  FREE_PRODUCT
  CASHBACK
}

enum PointsTransactionType {
  EARNED
  REDEEMED
  EXPIRED
  ADJUSTED
  BONUS
}

model LoyaltyProgram {
  id             String   @id @default(cuid())
  businessId     String   @unique

  // Configuration
  isActive       Boolean  @default(true)
  pointsPerReal  Decimal  @default(1) @db.Decimal(5, 2) // Points earned per R$1
  useCashback    Boolean  @default(false)
  cashbackPercent Decimal @default(5) @db.Decimal(5, 2)

  // Tier thresholds
  silverThreshold Int     @default(100)
  goldThreshold   Int     @default(500)
  diamondThreshold Int    @default(1000)

  // Tier benefits (discount %)
  bronzeDiscount  Decimal @default(0) @db.Decimal(5, 2)
  silverDiscount  Decimal @default(5) @db.Decimal(5, 2)
  goldDiscount    Decimal @default(10) @db.Decimal(5, 2)
  diamondDiscount Decimal @default(15) @db.Decimal(5, 2)

  // Expiration
  pointsExpirationMonths Int @default(12)

  // Timestamps
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  business       Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  rewards        LoyaltyReward[]

  @@map("loyalty_programs")
}

model LoyaltyPoints {
  id             String   @id @default(cuid())
  businessId     String
  clientId       String   @unique

  // Balance
  currentPoints  Int      @default(0)
  totalEarned    Int      @default(0)
  totalRedeemed  Int      @default(0)
  totalExpired   Int      @default(0)

  // Cashback balance (if using cashback mode)
  cashbackBalance Decimal @default(0) @db.Decimal(10, 2)

  // Tier
  currentTier    LoyaltyTier @default(BRONZE)

  // Timestamps
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  business       Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  client         Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  transactions   LoyaltyTransaction[]
  redemptions    LoyaltyRedemption[]

  @@index([businessId])
  @@map("loyalty_points")
}

model LoyaltyTransaction {
  id              String   @id @default(cuid())
  loyaltyPointsId String
  type            PointsTransactionType
  points          Int      // Positive for earned, negative for redeemed
  balance         Int      // Balance after transaction

  // Reference
  appointmentId   String?
  redemptionId    String?
  description     String?

  // Expiration (for earned points)
  expiresAt       DateTime?

  // Timestamps
  createdAt       DateTime @default(now())

  // Relations
  loyaltyPoints   LoyaltyPoints @relation(fields: [loyaltyPointsId], references: [id], onDelete: Cascade)

  @@index([loyaltyPointsId])
  @@index([expiresAt])
  @@map("loyalty_transactions")
}

model LoyaltyReward {
  id              String   @id @default(cuid())
  programId       String
  name            String
  description     String?

  // Cost
  pointsCost      Int

  // Reward details
  type            RewardType
  discountPercent Decimal? @db.Decimal(5, 2)
  discountAmount  Decimal? @db.Decimal(10, 2)
  serviceId       String?  // For free service
  productId       String?  // For free product

  // Limits
  isActive        Boolean  @default(true)
  validityDays    Int      @default(30)  // Coupon validity after redemption
  maxRedemptions  Int?     // null = unlimited

  // Stats
  totalRedemptions Int     @default(0)

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  program         LoyaltyProgram @relation(fields: [programId], references: [id], onDelete: Cascade)
  service         Service?       @relation(fields: [serviceId], references: [id], onDelete: SetNull)
  product         Product?       @relation(fields: [productId], references: [id], onDelete: SetNull)
  redemptions     LoyaltyRedemption[]

  @@index([programId])
  @@map("loyalty_rewards")
}

model LoyaltyRedemption {
  id              String   @id @default(cuid())
  loyaltyPointsId String
  rewardId        String
  clientId        String

  // Coupon
  couponCode      String   @unique
  pointsUsed      Int

  // Status
  isUsed          Boolean  @default(false)
  usedAt          DateTime?
  usedAppointmentId String?

  // Validity
  expiresAt       DateTime

  // Timestamps
  createdAt       DateTime @default(now())

  // Relations
  loyaltyPoints   LoyaltyPoints @relation(fields: [loyaltyPointsId], references: [id], onDelete: Cascade)
  reward          LoyaltyReward @relation(fields: [rewardId], references: [id], onDelete: Cascade)
  client          Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([loyaltyPointsId])
  @@index([clientId])
  @@index([couponCode])
  @@map("loyalty_redemptions")
}

// ============================================
// EPIC 12: CONTROLE DE ESTOQUE
// ============================================

enum ProductCategory {
  RESALE        // Para revenda
  INTERNAL_USE  // Uso interno apenas
  BOTH          // Ambos
}

enum StockMovementType {
  PURCHASE      // Compra
  SALE          // Venda
  SERVICE_USE   // Uso em serviço
  ADJUSTMENT    // Ajuste manual
  RETURN        // Devolução
  LOSS          // Perda
  EXPIRED       // Vencimento
}

model Product {
  id             String          @id @default(cuid())
  businessId     String
  name           String
  brand          String?
  description    String?
  sku            String?
  barcode        String?

  // Category
  category       ProductCategory @default(INTERNAL_USE)

  // Pricing
  costPrice      Decimal         @db.Decimal(10, 2)
  salePrice      Decimal?        @db.Decimal(10, 2)  // For resale

  // Stock
  currentStock   Decimal         @default(0) @db.Decimal(10, 3)
  minStock       Decimal         @default(0) @db.Decimal(10, 3)
  unit           String          @default("un") // un, ml, g, etc.

  // Expiration
  expirationDate DateTime?

  // Status
  isActive       Boolean         @default(true)
  imageUrl       String?

  // Timestamps
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  // Relations
  business       Business        @relation(fields: [businessId], references: [id], onDelete: Cascade)
  movements      StockMovement[]
  serviceProducts ServiceProduct[]
  loyaltyRewards  LoyaltyReward[]

  @@unique([businessId, sku])
  @@index([businessId])
  @@index([businessId, category])
  @@map("products")
}

model StockMovement {
  id             String            @id @default(cuid())
  businessId     String
  productId      String
  type           StockMovementType

  // Quantity (positive for in, negative for out)
  quantity       Decimal           @db.Decimal(10, 3)
  previousStock  Decimal           @db.Decimal(10, 3)
  newStock       Decimal           @db.Decimal(10, 3)

  // Cost tracking
  unitCost       Decimal?          @db.Decimal(10, 2)
  totalCost      Decimal?          @db.Decimal(10, 2)

  // Reference
  appointmentId  String?           // If used in service
  userId         String?           // Who made the movement
  notes          String?

  // Timestamps
  createdAt      DateTime          @default(now())

  // Relations
  business       Business          @relation(fields: [businessId], references: [id], onDelete: Cascade)
  product        Product           @relation(fields: [productId], references: [id], onDelete: Cascade)
  user           User?             @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([businessId])
  @@index([productId])
  @@index([createdAt])
  @@map("stock_movements")
}

model ServiceProduct {
  id             String   @id @default(cuid())
  serviceId      String
  productId      String

  // Usage per service
  quantityUsed   Decimal  @db.Decimal(10, 3)

  // Relations
  service        Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  product        Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([serviceId, productId])
  @@map("service_products")
}

// ============================================
// EPIC 13: PERFIL PROFISSIONAL & GAMIFICAÇÃO
// ============================================

enum GoalType {
  REVENUE         // Faturamento
  APPOINTMENTS    // Número de atendimentos
  NEW_CLIENTS     // Novos clientes
  RATING          // Avaliação média
  RETURN_RATE     // Taxa de retorno
}

enum BadgeType {
  MILESTONE       // 100 atendimentos, etc.
  RATING          // 5 estrelas
  STREAK          // Metas consecutivas
  SPECIAL         // Tempo de casa, etc.
}

model ProfessionalProfile {
  id              String   @id @default(cuid())
  userId          String   @unique

  // Public profile
  slug            String   @unique // URL: /p/slug
  bio             String?
  specialties     String[] // Array of specialties
  photoUrl        String?
  coverPhotoUrl   String?

  // Social links
  instagramUrl    String?
  facebookUrl     String?
  tiktokUrl       String?

  // Gallery
  portfolioImages String[] // Array of image URLs

  // Stats (denormalized)
  totalAppointments Int     @default(0)
  totalClients    Int       @default(0)
  averageRating   Decimal   @default(0) @db.Decimal(3, 2)
  totalRatings    Int       @default(0)

  // Marketing
  qrCodeUrl       String?
  referralCode    String?   @unique
  referralBonus   Decimal   @default(0) @db.Decimal(10, 2)  // Bonus for referred clients

  // Stats tracking
  clientsReferred Int       @default(0)

  // Visibility
  isPublic        Boolean   @default(true)

  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  goals           ProfessionalGoal[]
  badges          ProfessionalBadge[]

  @@map("professional_profiles")
}

model ProfessionalGoal {
  id              String   @id @default(cuid())
  profileId       String
  businessId      String

  // Goal definition
  type            GoalType
  targetValue     Decimal  @db.Decimal(10, 2)
  currentValue    Decimal  @default(0) @db.Decimal(10, 2)

  // Period
  month           Int      // 1-12
  year            Int

  // Status
  isAchieved      Boolean  @default(false)
  achievedAt      DateTime?

  // Bonus
  bonusAmount     Decimal? @db.Decimal(10, 2)
  bonusPaid       Boolean  @default(false)

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  profile         ProfessionalProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  business        Business            @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([profileId, type, month, year])
  @@index([profileId])
  @@index([businessId, month, year])
  @@map("professional_goals")
}

model ProfessionalBadge {
  id              String   @id @default(cuid())
  profileId       String
  type            BadgeType
  name            String
  description     String?
  iconUrl         String?

  // Achievement details
  requirement     String?  // e.g., "100 atendimentos"
  achievedValue   String?  // e.g., "100"

  // Timestamps
  earnedAt        DateTime @default(now())

  // Relations
  profile         ProfessionalProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@map("professional_badges")
}

model ProfessionalRanking {
  id              String   @id @default(cuid())
  businessId      String
  userId          String

  // Period
  month           Int
  year            Int

  // Metrics
  revenue         Decimal  @default(0) @db.Decimal(10, 2)
  appointments    Int      @default(0)
  newClients      Int      @default(0)
  averageRating   Decimal  @default(0) @db.Decimal(3, 2)
  returnRate      Decimal  @default(0) @db.Decimal(5, 2)

  // Ranking position
  position        Int?

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  business        Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([businessId, userId, month, year])
  @@index([businessId, month, year])
  @@map("professional_rankings")
}

// ============================================
// EPIC 10 EXPANDED: MARKETING INTELIGENTE
// ============================================

model MarketingSuggestion {
  id              String   @id @default(cuid())
  businessId      String

  // Suggestion
  type            String   // EMPTY_SLOT, LOW_DEMAND_SERVICE, INACTIVE_SEGMENT, etc.
  title           String
  description     String
  suggestedAction String?

  // Data
  metadata        Json?    // Additional data for the suggestion

  // Status
  isRead          Boolean  @default(false)
  isActioned      Boolean  @default(false)
  dismissedAt     DateTime?

  // Timestamps
  createdAt       DateTime @default(now())
  expiresAt       DateTime?

  // Relations
  business        Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([businessId, isRead])
  @@map("marketing_suggestions")
}

model ContentTemplate {
  id              String   @id @default(cuid())
  businessId      String?  // null = global template

  // Template info
  name            String
  category        String   // STORY, POST, WHATSAPP, PROMO
  occasion        String?  // CHRISTMAS, VALENTINES, BIRTHDAY, etc.

  // Content
  content         String
  imageUrl        String?
  variables       String[] // Variables like {{business_name}}, {{promo_percent}}

  // Status
  isActive        Boolean  @default(true)

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  business        Business? @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([category])
  @@map("content_templates")
}
